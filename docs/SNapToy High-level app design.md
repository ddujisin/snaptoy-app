### **High-Level App Design**

This high-level design outlines the architecture, features, and flow for your iOS app using the specified technologies and business requirements. The app is built on a solid foundation of Expo and a custom backend, ensuring a scalable and maintainable product.

---

### **1\. High-Level Architecture**

The application uses a microservices-like architecture with a clear separation between the client and the backend.

* **Frontend (iOS App):** The app is built with **Expo, Expo Modules, and Expo Router**. This provides a streamlined development experience, access to native device features, and efficient navigation. All user-facing logic, UI/UX, and data presentation will be handled here.  
* **Backend (REST API):** A **React/Express REST API** acts as a secure intermediary between the app and external services. Its primary responsibilities include:  
  * Securely storing and using API keys for services like Photoroom.  
  * Managing user authentication tokens and sessions.  
  * Handling credit packages and tracking photo credits usage.  
  * Orchestrating all calls to the Photoroom API.

This design ensures that sensitive information is never exposed on the client and that business logic, such as package management, is centralized and secure.

---

### **2\. User Authentication**

User authentication will be handled exclusively through Apple Sign-In, providing a quick and secure onboarding process for iOS users.

* **Client-Side:** The app will use the **expo-apple-authentication** module. Upon a user's successful sign-in, the client will receive a secure token.  
* **Backend-Side:** This token is immediately sent to your backend server. The server will then verify the token with Apple's servers to ensure its validity and create a new user entry in your database, linking it to the user's Apple ID. A session token is then generated by your server and sent back to the app for all future authenticated requests.

---

### **3\. Image Handling**

The app provides two options for photo input, both managed by standard Expo libraries.

* **expo-image-picker:** This module will be used to allow users to select an existing photo from their camera roll.  
* **expo-camera:** This module provides a camera view and capture functionality for users to take a new picture directly within the app.

Both methods will grant the app the necessary permissions to access the device's camera and photo library, ensuring a seamless user experience.

---

### **4\. Object Selection**

The app will leverage on-device machine learning for a fast and private object selection process.

* **Executorch:** This library will be used to perform **on-device object detection**. When a user selects or takes a photo, the app will run a lightweight ML model to automatically detect the main subject (e.g., the toy).  
* **User Flow:** A bounding box will be displayed over the detected object. The user will then be prompted to confirm if the selection is correct. If the detection is successful, the app proceeds to the next step. If the detection fails or is inaccurate, the user will be prompted to either take another photo or manually adjust the selection, avoiding a hard-coded failure point. This puts the user in control, reducing frustration.

---

### **5\. AI Image Transformation**

All image transformation will be handled by the Photoroom API via your backend server.

* **Backend Endpoint:** The backend will have a dedicated endpoint for POST /api/transform. This endpoint will accept the user's image, the selected background type (Cartoon, Lego, Photo), and the user's optional manual prompt.  
* **Prompt Generation:** For each background type, a precise and pre-defined prompt will be sent to the Photoroom API.  
  * **Cartoon:** The app will combine a base prompt like "a cartoon background, vibrant colors, detailed illustration" with the user's photo and any manual additions.  
  * **Lego:** The prompt will include terms like "a Lego world, bricks, studs, blocky figures, plastic texture."  
  * **Photo:** The prompt would be more realistic, such as "a natural landscape, realistic studio background, outdoor setting."  
* **User Guidance:** The app's UI will guide users to enter effective prompts, providing examples or hints.

---

### **6\. Paywall and credit packages**

Monetization will be implemented with a package model that uses photo credits and the option to purchase more.

* **Extra Credits:** A button will allow users to purchase an additional photos for cash. The packages are defined in the backend and shown to the user via API. This is a one-time in-app purchase that adds to their current credit balance.   

The backend will be responsible for managing user packages, deducting credits for each successful photo transformation, and handling receipt validation from Apple's App Store.
